<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spartans Meeting Logger</title>
  <style>
    :root{
      --sn-red:#DD467D; --sn-red-light:#F7B4CC; --sn-black:#111827; --sn-gray:#6b7280; --sn-orange:#ea580c;
      --rec-bg:#f9fafb; --bg:#f8fafc; --card:#ffffff; --line:#e5e7eb;
      --steel-0:#f3f6fb; --steel-1:#e5ecf5; --steel-2:#cfd9e6; --steel-3:#aebbd0;
    }
    @supports (color: color-mix(in srgb, black, white)) {
      :root{ --sn-red-light: color-mix(in srgb, var(--sn-red) 35%, white); }
    }
    html,body{min-height:100%}
    body{
      background-color:var(--steel-1);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    @supports (height:100dvh){ body::before{height:100dvh} }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1100px 700px at 0% 0%, rgba(99,102,241,.10), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(14,165,233,.10), transparent 55%),
        linear-gradient(145deg, var(--steel-0) 0%, var(--steel-1) 32%, var(--steel-2) 66%, var(--steel-3) 100%);
    }
    @keyframes toastIn{from{transform:translateY(-10px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes toastBar{from{transform:scaleX(1)}to{transform:scaleX(0)}}
    input,select,button,textarea{font:inherit;font-size:16px}
    input[type="date"],input[type="time"]{
      -webkit-appearance:none;appearance:none;height:3rem;line-height:3rem;padding:0 1rem;font-size:16px;font-variant-numeric:tabular-nums;
    }
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preload" href="./supernova-wordmark.png" as="image">
</head>
<body>
  <div id="root"></div>

  <!-- React + Babel (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- App -->
  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;
    const SYNC_URL = "/api/sync";   // ← our secure proxy

    const btnSecondary =
      "rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold " +
      "text-slate-900 shadow-sm hover:bg-slate-50 active:scale-[0.98] " +
      "disabled:opacity-60 disabled:cursor-not-allowed";
    
    const cls = (...xs) => xs.filter(Boolean).join(" ");
    const todayISODate = () => new Date().toISOString().slice(0,10);
    const nowHM = () => { const d=new Date(); return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); };
    const dayName = (iso) => new Date(iso).toLocaleDateString(undefined,{weekday:"long"});

    const LS = { settings:"sn.meet.settings.v1", history:"sn.meet.history.v1", outbox:"sn.meet.outbox.v1" };
    const LS_SYNC = { last: "sn.meet.lastsync.v1" };

    const DEFAULT_ENDPOINT = "https://script.google.com/macros/s/AKfycbyIvFrqE7DwV7TgOx9L3tfDz14F8j9_ePSfhAmpTOB2Mt-LdkLq3h4bFKHQjQUUpZc0UQ/exec";

    const baseField = "w-full h-14 rounded-2xl border border-slate-300 bg-white px-3 text-[16px] leading-none shadow-sm outline-none focus:border-slate-400";

    const UNIT_OPTIONS = ["Supernova Direct","Aquila Direct","Stellar Direct","Aurora","Alphara"];
    const PRODUCT_OPTIONS = ["A+ Signature","ACP 100","AHIP","Ascend","Family Secure","Future Builder","Future Scholar","Goals Protect","Guardian 1","Guardian 65","Health Achieve","Max Protect","Money Tree","Other"];
    const MEETING_PLACES = ["Zoom","Cafe/Resto","Client Home","Client Office","AIA Office","Other"];

    const QUOTES = [
      "Great days are built one call at a time.","Consistency compounds. Keep swinging!","Prospect today, paid tomorrow.","Hard work works!",
      "Tiny progress today, massive results later.","Energy up, pipeline up!","Every conversation is a seed.","Discipline > motivation!",
      "Energy is contagious—share it!","You only lose if you stop."
    ];
    const getRandomQuote = () => QUOTES[Math.floor(Math.random()*QUOTES.length)];

    const defaultSettings = { advisorName: "", unit: "", syncKey: "" };
    const emptyForm = { prospectName:"", date:todayISODate(), time:nowHM(), meetingPlace:"Zoom",
      firstMeeting:true, meetingCount:1, factFinding:false, appSubmitted:false, casePaid:false,
      caseApproved:false, referralsGiven:0, fyp:"", fyc:"", product:"" };

    const readLS = (k,f)=>{ try{ const v=JSON.parse(localStorage.getItem(k)||"null"); return v??f; }catch{return f;} };
    const writeLS = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

    const Page = ({children}) => (
      <div className="min-h-[100dvh] w-full bg-transparent text-slate-900">
        <div className="mx-auto w-full max-w-md px-4 pb-36">{children}</div>
      </div>
    );

    // put near the top of your script (you already have this line)
    const LOGO_SRC = "./supernova-wordmark.png";
    
    // replace the whole TopBar component with this:
    const TopBar = ({ settingsOpen, onToggleSettings, pendingCount }) => (
      <header className="sticky top-0 z-50 mb-4 bg-white/90 backdrop-blur border-b border-slate-200 rounded-b-2xl shadow-sm overflow-hidden">
        <div className="flex items-center justify-between px-4 pt-4">
          <img src={LOGO_SRC} alt="Supernova Financial" className="h-12 md:h-14 select-none" />
          <button
            onClick={onToggleSettings}
            aria-pressed={settingsOpen}
            aria-expanded={settingsOpen}
            className={
              "rounded-2xl border px-3 py-1.5 text-sm transition shadow-sm " +
              (settingsOpen
                ? "bg-slate-900 text-white border-slate-900 shadow-inner translate-y-[1px]"
                : "bg-white text-slate-700 border-slate-200 hover:bg-slate-50 active:scale-[0.98]")
            }
          >
            <span
              className={
                "mr-1 inline-block transition-transform duration-200 " +
                (settingsOpen ? "rotate-90" : "")
              }
              aria-hidden="true"
            >
              ⚙️
            </span>
            Settings
          </button>
        </div>
    
        <div className="flex items-center justify-between px-4 pt-2 pb-5">
          <div className="flex items-center gap-2">
            <span className="inline-block h-3 w-3 rounded-full" style={{ backgroundColor: "var(--sn-red)" }} />
            <h1 className="text-xl md:text-2xl font-bold leading-tight">Meeting Logger</h1>
          </div>
        </div>
    
        {pendingCount > 0 && (
          <div className="px-4 pb-3">
            <span className="inline-flex items-center gap-2 rounded-full bg-amber-200/70 text-amber-900 text-xs font-semibold px-3 py-1">
              <span className="inline-block h-2 w-2 rounded-full bg-amber-600" />
              {pendingCount} queued — will sync when online
            </span>
          </div>
        )}
      </header>
    );
        
    const Section = ({title,children,right}) => (
      <section className="mb-4 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div className="mb-3 flex items-center justify-between">
          <h2 className="text-sm font-semibold tracking-wide text-slate-600 uppercase">{title}</h2>{right}
        </div>{children}
      </section>
    );
    const LabeledInput = ({label,children}) => (
      <label className="mb-4 block">
        <div className="mb-2 text-[13px] font-medium text-slate-600">{label}</div>
        {children}
      </label>
    );

    const TextInput = ({ value, onChange, placeholder, type="text", inputMode }) => (
      <input value={value} onChange={(e)=>onChange(e.target.value)} type={type} inputMode={inputMode} placeholder={placeholder} className={baseField}/>
    );
    const NumberInput = ({ value, onChange, step=1, min=0, placeholder }) => (
      <input value={value} onChange={(e)=>onChange(e.target.value===""?"":Number(e.target.value))} type="number" step={step} min={min} inputMode="numeric" placeholder={placeholder} className={baseField+" appearance-none"}/>
    );
    const MoneyInput = ({ value, onChange, placeholder, disabled = false }) => {
      const display = value === "" || value == null ? "" : new Intl.NumberFormat("en-PH").format(Number(value));
      return (
        <input
          type="text"
          inputMode="numeric"
          value={display}
          placeholder={placeholder}
          onChange={(e) => {
            if (disabled) return;
            const digits = e.target.value.replace(/\D/g, "");
            onChange(digits === "" ? "" : Number(digits));
          }}
          disabled={disabled}
          className={cls(
            "w-full rounded-xl px-3 py-3 text-base shadow-sm outline-none border",
            disabled
              ? "bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed"
              : "bg-white border-slate-300 focus:border-slate-400"
          )}
        />
      );
    };
    const Select = ({ value, onChange, options, placeholder, disabled = false }) => (
      <div className="relative">
        <select
          value={value}
          onChange={(e) => onChange(e.target.value)}
          disabled={disabled}
          className={cls(
            baseField,
            "appearance-none pr-10",
            disabled && "bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed"
          )}
        >
          <option value="" disabled hidden>{placeholder || "-- Select --"}</option>
          {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
        </select>
        <svg
          className={cls(
            "pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5",
            disabled ? "text-slate-300" : "text-slate-400"
          )}
          viewBox="0 0 20 20"
          fill="currentColor"
          aria-hidden="true"
        >
          <path fillRule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clipRule="evenodd"/>
        </svg>
      </div>
    );
    const ChoiceGrid = ({ options, value, onChange }) => (
      <div className="grid grid-cols-2 gap-3">
        {options.map(opt=>(
          <button key={opt} type="button" onClick={()=>onChange(opt)}
            className={cls("h-16 rounded-2xl border text-base font-semibold transition active:scale-[0.99]",
              value===opt ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-800 border-slate-300")}>
            {opt}
          </button>
        ))}
      </div>
    );
    
    const FloatingTabBar = ({ tab, setTab }) => (
      <div className="fixed z-50 pointer-events-none bottom-[calc(env(safe-area-inset-bottom)+12px)] left-2 right-2 sm:left-1/2 sm:right-auto sm:-translate-x-1/2 sm:w-[30rem]">
        <div className="pointer-events-auto rounded-2xl bg-[var(--sn-red)] p-2 grid grid-cols-3 gap-2 shadow-xl ring-1 ring-black/10 backdrop-blur">
    
          {/* Log New Meeting */}
          <button
            onClick={() => setTab("log")}
            className={cls(
              "h-16 rounded-xl font-semibold transition flex items-center justify-center",
              tab === "log" ? "bg-[var(--sn-red-light)] text-[var(--sn-black)]" : "bg-white text-[var(--sn-black)]"
            )}
            aria-pressed={tab === "log"}
            aria-label="Log New Meeting"
          >
            <div className="flex flex-col items-center leading-tight pt-1 pb-1">
              <img src="log.svg" alt="" aria-hidden="true" className="w-7 h-7 sm:w-8 sm:h-8 mb-1.5 opacity-90 object-contain"/>
              <span className="text-[13px]">New Meeting</span>
            </div>
          </button>
    
          {/* History */}
          <button
            onClick={() => setTab("history")}
            className={cls(
              "h-16 rounded-xl font-semibold transition flex items-center justify-center",
              tab === "history" ? "bg-[var(--sn-red-light)] text-[var(--sn-black)]" : "bg-white text-[var(--sn-black)]"
            )}
            aria-pressed={tab === "history"}
            aria-label="History"
          >
            <div className="flex flex-col items-center leading-tight pt-1 pb-1">
              <img src="history.svg" alt="" aria-hidden="true" className="w-7 h-7 sm:w-8 sm:h-8 mb-1.5 opacity-90 object-contain"/>
              <span className="text-[13px]">History</span>
            </div>
          </button>
    
          {/* Prospecting */}
          <button
            onClick={() => setTab("prospecting")}
            className={cls(
              "h-16 rounded-xl font-semibold transition flex items-center justify-center",
              tab === "prospecting" ? "bg-[var(--sn-red-light)] text-[var(--sn-black)]" : "bg-white text-[var(--sn-black)]"
            )}
            aria-pressed={tab === "prospecting"}
            aria-label="Prospecting"
          >
            <div className="flex flex-col items-center leading-tight pt-1 pb-1">
              <span className="w-7 h-7 sm:w-8 sm:h-8 mb-1.5 opacity-90 text-xl" aria-hidden="true">⏱️</span>
              <span className="text-[13px]">Prospecting</span>
            </div>
          </button>
    
        </div>
      </div>
    );

    const YesNoCard = ({ label, value, onChange }) => (
      <button type="button" onClick={()=>onChange(!value)}
        className={cls("flex h-16 w-full items-center justify-between rounded-2xl border text-lg font-semibold shadow-sm px-4 active:scale-[0.99] transition",
          value ? "bg-emerald-500 border-emerald-300 text-white" : "text-white")}
        style={ value ? undefined : { backgroundColor:"var(--sn-red)", borderColor:"var(--sn-red)" } }>
        <span className="text-left text-sm font-medium opacity-90">{label}</span>
        <span className="text-xl tracking-wide">{value?"YES":"NO"}</span>
      </button>
    );
    const YesNoGrid = ({ items, form, setForm }) => (
      <div className="grid grid-cols-2 gap-3">
        {items.map(it=>(
          <YesNoCard key={it.key} label={it.label} value={!!form[it.key]} onChange={(v)=>setForm(f=>({...f,[it.key]:v}))}/>
        ))}
      </div>
    );

    const Toast = ({ text, quote, type="ok", onClose }) => {
      React.useEffect(()=>{ const t=setTimeout(onClose,3000); navigator.vibrate?.(40); return ()=>clearTimeout(t); },[onClose]);
      const bg = type==="ok" ? "bg-emerald-600" : type==="warn" ? "bg-amber-500" : "bg-[var(--sn-red)]";
      const icon = type==="ok" ? "✅" : type==="warn" ? "⚠️" : "✖️";
      return (
        <div className="fixed inset-0 z-[120] flex items-start justify-center pointer-events-none" role="status" aria-live="polite">
          <div className="mt-16 md:mt-24 pointer-events-auto animate-[toastIn_.18s_ease-out]">
            <div className={`rounded-2xl px-5 py-3 text-white shadow-2xl ring-1 ring-black/10 backdrop-blur ${bg}`}>
              <div className="flex items-center justify-between gap-3">
                <div className="text-lg md:text-xl font-bold">{text}</div>
                <span className="text-2xl leading-none">{icon}</span>
              </div>
              {quote && <div className="mt-1 text-[13px] md:text-sm opacity-90">{quote}</div>}
            </div>
            <div className="h-1 rounded-b-2xl overflow-hidden bg-white/30">
              <div className="h-full bg-white/90 origin-left animate-[toastBar_3s_linear]" />
            </div>
          </div>
        </div>
      );
    };
    const Badge = ({children}) => (
      <span className="inline-flex items-center rounded-full border border-emerald-300 bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700">{children}</span>
    );

    async function sendToEndpoint(url, record){
      const endpoint=(url||"").trim(); if(!endpoint) return false;
      try{
        const res=await fetch(endpoint,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain"},body:JSON.stringify(record)});
        return res.ok || res.type==="opaque";
      }catch{ return false; }
    }

    function App(){
      const [lastSyncAt, setLastSyncAt] = useState(() => readLS(LS_SYNC.last, ""));
      
      // state (declare before effects)
      const [settings,setSettings]=useState(()=>({...defaultSettings,...readLS(LS.settings,{})}));
      const [form,setForm]=useState(()=>({...emptyForm}));
      const [tab,setTab]=useState("log");
      const [history,setHistory]=useState(()=>readLS(LS.history,[]));
      const [outbox,setOutbox]=useState(()=>readLS(LS.outbox,[]));
      const [openSettings,setOpenSettings]=useState(false);
      const [toast,setToast]=useState(null);
      const [editingId,setEditingId]=useState(null);

      // --- Prospecting helpers ---
      const weekEndingSunday = (isoDate) => {
        // compute the Sunday of that ISO date (sheet shows Sundays as "Week Ending")
        const d = new Date(`${isoDate}T00:00:00`);
        const day = d.getDay();            // 0=Sun ... 6=Sat
        const add = (7 - day) % 7;         // days to next Sunday (0 if already Sunday)
        d.setDate(d.getDate() + add);
        return d.toISOString().slice(0,10);
      };

      // --- maintenance helpers ---
      function clearHistoryAndOutbox() {
        localStorage.removeItem(LS.history);
        localStorage.removeItem(LS.outbox);
        localStorage.removeItem(LS_SYNC.last);
        setHistory([]);
        setOutbox([]);
        setLastSyncAt("");
        setToast({ t: "Cleared local history and outbox. You can sync again.", type: "ok" });
      }
      
      function forceFullSync() {
        setLastSyncAt("");
        writeLS(LS_SYNC.last, "");
        pullUpdates();
      }
      
      function nukeEverything() {
        if (!confirm("Remove ALL settings (name, unit, sync key) and local data?")) return;
        localStorage.clear();
        location.reload();
      }

      function cancelEdit() {
        setEditingId(null);     // stop editing
        resetForm();            // clear the edit form
        setTab('history');      // go back to History
        setToast({ t: 'Edit cancelled.', type: 'ok' });
      }

      // Jump to a tab, but first cancel any edit and close Settings.
      const goToTab = (dest) => {
        if (openSettings) setOpenSettings(false);   // close Settings if open
        if (editingId) {
          setEditingId(null);
          resetForm();
          setToast({
            t: dest === 'log'
              ? 'Edit cancelled. Starting a new log.'
              : 'Edit cancelled.',
            type: 'ok'
          });
        }
        setTab(dest);
      };

      const [showAdvanced, setShowAdvanced] = useState(false);

      const CounterCard = ({ label, value, onPlus, onMinus }) => (
        <div className="rounded-2xl border border-slate-200 bg-white p-3 shadow-sm">
          <div className="text-center text-[13px] font-medium text-slate-600 mb-2">{label}</div>
          <div className="flex items-center justify-between gap-3">
            <button onClick={onMinus} className="h-12 w-12 rounded-xl border border-slate-300 bg-white text-xl font-bold hover:bg-slate-50">–</button>
            <div className="text-5xl font-black tabular-nums select-none">{value}</div>
            <button onClick={onPlus} className="h-12 w-12 rounded-xl border border-slate-300 bg-white text-xl font-bold hover:bg-slate-50">+</button>
          </div>
        </div>
      );

      // Increment/decrement helpers
      const inc = (k) => setProspecting(p => ({ ...p, [k]: (p[k] || 0) + 1 }));
      const dec = (k) => setProspecting(p => ({ ...p, [k]: Math.max(0, (p[k] || 0) - 1) }));

      // Prospecting tab state
      const [prospecting, setProspecting] = useState({
        date: todayISODate(),
        approaches: 0,
        setApps: 0
      });
      
      // Derived week-ending for sheet
      const weekEnding = useMemo(
        () => weekEndingSunday(prospecting.date),
        [prospecting.date]
      );
      
      // Build the prospecting payload to send
      const prospectingPayload = useMemo(() => ({
        type: "prospecting",
        advisor: settings.advisorName,
        unit: settings.unit,
        // srUnit is optional; include if you decide to capture it in Settings later
        srUnit: "",
        weekEnding,                            // Sunday ISO string
        approaches: Number(prospecting.approaches) || 0,
        setAppointments: Number(prospecting.setApps) || 0,
        timestamp: new Date().toISOString()
      }), [settings, weekEnding, prospecting]);

      // Submit Handler
      const submitProspecting = async () => {
        if (!settings.advisorName) { setToast({ t:"Set your name in Settings first.", type:"warn" }); setOpenSettings(true); return; }
        if (!settings.unit)        { setToast({ t:"Select your Unit in Settings.", type:"warn" }); setOpenSettings(true); return; }
        if ((prospecting.approaches||0)===0 && (prospecting.setApps||0)===0) {
          setToast({ t:"Nothing to submit.", type:"warn" });
          return;
        }
      
        const id = crypto.randomUUID?.() || String(Date.now());
        const record = { id, ...prospectingPayload };
      
        const ok = await sendToEndpoint(DEFAULT_ENDPOINT, record);
        if (!ok) {
          setOutbox(o => [record, ...o]);
          setToast({ t:"Saved offline — will sync when online.", type:"warn" });
        } else {
          setToast({ t:"Prospecting submitted!", type:"ok" });
        }
      
        // keep date; reset counts
        setProspecting(p => ({ ...p, approaches: 0, setApps: 0 }));
      };


      // Merge server records into local history by id (fallback: entryID)
      function mergeServerUpdates(updates) {
        if (!Array.isArray(updates) || updates.length === 0) return;
      
        setHistory(h => {
          const byId = new Map(h.map((r, i) => [r.id, i]));
          const byEntry = new Map(h.map((r, i) => [r.entryID, i]).filter(([k]) => !!k));
          const next = h.slice();
      
          for (const u of updates) {
            const keyId = u.id != null ? String(u.id) : null;
            const keyEntry = u.entryID != null ? String(u.entryID) : null;
      
            let idx = (keyId && byId.has(keyId)) ? byId.get(keyId) :
                      (keyEntry && byEntry.has(keyEntry)) ? byEntry.get(keyEntry) : -1;
      
            // Normalize a few fields so the UI stays consistent
            if (u.firstMeeting != null && (u.firstMeeting === true || u.firstMeeting === "true")) u.firstMeeting = "Yes";
            if (u.factFinding != null && (u.factFinding === true || u.factFinding === "true")) u.factFinding = "Yes";
            if (u.appSubmitted != null && (u.appSubmitted === true || u.appSubmitted === "true")) u.appSubmitted = "Yes";
            if (u.casePaid != null && (u.casePaid === true || u.casePaid === "true")) u.casePaid = "Yes";
            if (u.caseApproved != null && (u.caseApproved === true || u.caseApproved === "true")) u.caseApproved = "Yes";
      
            if (idx >= 0) {
              next[idx] = { ...next[idx], ...u };     // overwrite with admin-edited version
            } else {
              // new to this device; append at top
              next.unshift({ id: keyId || crypto.randomUUID?.() || String(Date.now()), ...u });
            }
          }
          return next;
        });
      
        // If any of the updates match outbox ids, remove them (server has them already)
        setOutbox(o => o.filter(rec => !updates.some(u => String(u.id||"") === String(rec.id||""))));
      }

      // Pull updates from server since lastSyncAt for this advisor
      async function pullUpdates() {
        if (!settings.advisorName || !settings.syncKey) return;
      
        const since = lastSyncAt || "1970-01-01T00:00:00Z";
      
        try {
          const qs = new URLSearchParams({
            since,
            advisor: settings.advisorName,
            key: settings.syncKey
          });
          const res = await fetch(`${SYNC_URL}?${qs.toString()}`);
      
          if (!res.ok) {
            setToast({ t: `Sync failed (${res.status}).`, type: "warn" });
            return;
          }
          if (res.status === 401) {
            setToast({ t: "Invalid sync key — check Settings.", type: "warn" });
            return;
          }
      
          const json = await res.json().catch(() => null);
          if (!json || json.ok !== true) {
            setToast({ t: "Sync failed (bad response).", type: "warn" });
            return;
          }
      
          const updates = Array.isArray(json.updated) ? json.updated : [];
          if (updates.length > 0) {
            mergeServerUpdates(updates);
            setToast({ t: `Pulled ${updates.length} update${updates.length > 1 ? "s" : ""} 🔄`, type: "ok" });
          } else {
            // This is the important feedback when nothing changed
            setToast({ t: "Sync: No new changes found.", type: "ok" });
          }
      
          const nowIso = new Date().toISOString();
          setLastSyncAt(nowIso);
          writeLS(LS_SYNC.last, nowIso);
        } catch (e) {
          setToast({ t: "Sync failed (offline?).", type: "warn" });
        }
      }

      // auto-open settings if needed
      useEffect(()=>{ if(!settings.advisorName || !settings.unit){ setOpenSettings(true); } },[]);

      // persist to localStorage
      useEffect(()=>writeLS(LS.settings,settings),[settings]);
      useEffect(()=>writeLS(LS.history,history),[history]);
      useEffect(()=>writeLS(LS.outbox,outbox),[outbox]);

      // keep meetingCount/firstMeeting in sync
      useEffect(()=>{ setForm(f=>({...f,meetingCount:f.firstMeeting?1:Math.max(2,Number(f.meetingCount)||2)})); },[form.firstMeeting]);
      useEffect(()=>{
        const n=Number(form.meetingCount)||0;
        if(n>1 && form.firstMeeting) setForm(f=>({...f,firstMeeting:false}));
        else if(n===1 && !form.firstMeeting) setForm(f=>({...f,firstMeeting:true}));
      },[form.meetingCount]);

      // A) Flush outbox when it changes, and when the device comes back online
      useEffect(() => {
        const flushOutbox = async () => {
          if (outbox.length === 0) return;
          let sent = 0;
          const remaining = [];
          for (const item of outbox) {
            const ok = await sendToEndpoint(DEFAULT_ENDPOINT, item);
            if (ok) sent++; else remaining.push(item);
          }
          if (remaining.length !== outbox.length) {
            setOutbox(remaining);
            if (sent > 0) setToast({ t: `Synced ${sent} queued ${sent === 1 ? "item" : "items"}. ✅`, type: "ok" });
          }
        };
      
        flushOutbox();
      
        const onOnline = () => flushOutbox();           // only flush on reconnect
        window.addEventListener("online", onOnline);
        return () => window.removeEventListener("online", onOnline);
      }, [outbox]);
      
      // B) Do one quiet pull when creds become available (first load or after typing them)
      useEffect(() => {
        if (settings.advisorName && settings.syncKey) {
          pullUpdates({ quietIfNone: true });           // no toast if there’s nothing new
        }
      }, [settings.advisorName, settings.syncKey]);

      // Fire a one-off pull when name or key becomes valid
      useEffect(() => {
        if (settings.advisorName && settings.syncKey) {
          pullUpdates();
        }
      }, [settings.advisorName, settings.syncKey]);

      // scroll to top when opening settings
      useEffect(()=>{ if(openSettings){ requestAnimationFrame(()=>{ try{ window.scrollTo({top:0,behavior:"smooth"});}catch{} }); } },[openSettings]);

      const yesNoItems = useMemo(()=>[
        {key:"firstMeeting",label:"1st Meeting?"},
        {key:"factFinding",label:"KYC Done?"},
        {key:"appSubmitted",label:"Submitted?"},
        {key:"casePaid",label:"Paid?"},
        {key:"caseApproved",label:"Approved?"},
      ],[]);

      function recordToForm(r){
        return {
          prospectName:r.prospect||"", date:r.date||todayISODate(), time:r.appointmentTime||nowHM(),
          meetingPlace:r.meetingPlace||"Zoom",
          firstMeeting:(r.firstMeeting==="Yes"),
          meetingCount:Number(r.noOfMeetings || (r.firstMeeting==="Yes"?1:2)),
          factFinding:(r.factFinding==="Yes"),
          appSubmitted:(r.appSubmitted==="Yes"),
          casePaid:(r.casePaid==="Yes"),
          caseApproved:(r.caseApproved==="Yes"),
          referralsGiven:Number(r.referralsGiven||0),
          fyp:r.fyp??"", fyc:r.fyc??"", product:r.product||""
        };
      }
      function startEdit(rec){
        setOpenSettings(false); setEditingId(rec.id); setForm(recordToForm(rec)); setTab("log");
        setToast({ t:"Loaded for editing.", type:"ok" });
        try{ window.scrollTo({top:0,behavior:"smooth"}); }catch{}
      }

      const resetForm=()=>setForm({...emptyForm,meetingPlace:form.meetingPlace});
      const payload = useMemo(()=>{
        const dt=`${form.date} ${form.time}`;
        return {
          advisor: settings.advisorName, unit: settings.unit, prospect: form.prospectName,
          date: form.date, day: dayName(form.date), appointmentTime: form.time, meetingPlace: form.meetingPlace,
          firstMeeting: form.firstMeeting?"Yes":"No", noOfMeetings: Number(form.meetingCount)||0,
          factFinding: form.factFinding?"Yes":"No", appSubmitted: form.appSubmitted?"Yes":"No",
          casePaid: form.casePaid?"Yes":"No", referralsGiven: Number(form.referralsGiven)||0,
          fyp: form.fyp===""? "" : Number(form.fyp), fyc: form.fyc===""? "" : Number(form.fyc),
          product: form.product, caseApproved: form.caseApproved?"Yes":"No",
          timestamp: new Date().toISOString(), dt
        };
      },[form,settings]);

      const [isSending,setIsSending]=useState(false);
      const handleSubmit = async ()=>{
        if(isSending) return;
        if(!settings.advisorName){ setToast({t:"Set your name in Settings first.",type:"warn"}); setOpenSettings(true); return; }
        if(!settings.unit){ setToast({t:"Select your Unit in Settings.",type:"warn"}); setOpenSettings(true); return; }
        if(!form.prospectName){ setToast({t:"Prospect name is required.",type:"warn"}); return; }

        setIsSending(true);
        const id = editingId || (crypto.randomUUID?.() || String(Date.now()));
        const record = { id, ...payload };
        setHistory(h => editingId ? h.map(x => x.id===editingId ? record : x) : [record, ...h].slice(0,200));

        const ok = await sendToEndpoint(DEFAULT_ENDPOINT, record);
        if(!ok){ setOutbox(o=>[record,...o]); setToast({ t:"Saved offline — will sync when online.", type:"warn" }); }
        else{ setToast({ t: editingId ? "Updated!" : "Submitted!", quote:getRandomQuote(), type:"ok" }); }

        setEditingId(null); resetForm(); setIsSending(false);
      };

      const pendingCount = outbox.length;
      const canEditAmounts = !!(form.appSubmitted || form.casePaid || form.caseApproved);
      
      return (
        <Page>
          <TopBar settingsOpen={openSettings} onToggleSettings={() => setOpenSettings(v => !v)} pendingCount={pendingCount} />

          {openSettings && (
            <Section title="SETTINGS">
              <div className="grid gap-4">
                {/* 1) Basic settings */}
                <LabeledInput label="Your Name (Advisor)">
                  <TextInput
                    value={settings.advisorName}
                    onChange={v => setSettings(s => ({ ...s, advisorName: v }))}
                    placeholder="e.g., Jimmy Santos"
                  />
                </LabeledInput>
          
                <LabeledInput label="Unit *">
                  <Select
                    value={settings.unit}
                    onChange={v => setSettings(s => ({ ...s, unit: v }))}
                    options={UNIT_OPTIONS}
                    placeholder="-- Select Unit --"
                  />
                </LabeledInput>
          
                <LabeledInput label="Sync Key">
                  <TextInput
                    value={settings.syncKey}
                    onChange={v => setSettings(s => ({ ...s, syncKey: v }))}
                    placeholder="Paste the key from admin"
                  />
                </LabeledInput>
          
                {/* 2) Sync area */}
                <div className="rounded-xl border border-slate-200 bg-slate-50 p-3">
                  <div className="flex items-center justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-slate-700">Sync</div>
                      <div className="text-xs text-slate-600 truncate">
                        Last sync: {lastSyncAt ? new Date(lastSyncAt).toLocaleString() : "Never"}
                      </div>
                    </div>

                  <button
                    type="button"
                    onClick={() => pullUpdates({ quietIfNone: false })}
                    disabled={!settings.advisorName || !settings.syncKey}
                    className={cls(
                      // match "Done" exactly when enabled
                      "rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:opacity-95 active:scale-[0.98]",
                      // subtle disabled look (same color, just dimmed)
                      (!settings.advisorName || !settings.syncKey) && "opacity-50 cursor-not-allowed hover:opacity-50"
                    )}
                    title={
                      !settings.advisorName || !settings.syncKey
                        ? "Enter Advisor Name and Sync Key first"
                        : "Pull admin updates now"
                    }
                  >
                    Sync now
                  </button>

                  </div>
                  {/* Advanced tools (collapsed by default) */}
                  <button
                    type="button"
                    onClick={() => setShowAdvanced(v => !v)}
                    className="mt-3 text-xs text-slate-600 underline"
                  >
                    {showAdvanced ? "Hide advanced" : "Advanced…"}
                  </button>
          
                  {showAdvanced && (
                    <div className="mt-3 grid gap-2">
                      <button
                        type="button"
                        onClick={clearHistoryAndOutbox}
                        className="rounded-xl border border-rose-300 bg-rose-600/10 px-3 py-2 text-sm font-medium text-rose-700 hover:bg-rose-600/20 active:scale-[0.98]"
                      >
                        🧹 Clear on This Phone
                      </button>
          
                      <button
                        type="button"
                        onClick={forceFullSync}
                        disabled={!settings.advisorName || !settings.syncKey}
                        className={btnSecondary}
                      >
                        🔄 Get a Fresh Copy
                      </button>

                      <button
                        type="button"
                        onClick={nukeEverything}
                        className="rounded-xl border border-rose-300 bg-rose-600/10 px-3 py-2 text-sm font-medium text-rose-700 hover:bg-rose-600/20 active:scale-[0.98]"
                      >
                         ↺ Reset App on Phone
                      </button>
          
                      <div className="mt-1 space-y-1 text-[11px] leading-snug text-slate-500">
                        <div>
                          <span className="font-semibold">🧹 Clear on This Phone </span>
                          — removes the meeting list and outbox on this device only. Your name, unit, and sync key stay saved.
                        </div>
                        <div>
                          <span className="font-semibold">🔄 Get a Fresh Copy </span>
                          — re-downloads all your entries from the server and merges them. Safe anytime (e.g., after a cleanup or new phone).
                        </div>
                        <div>
                          <span className="font-semibold">↺ Reset App on Phone </span>
                          — resets this app’s saved data on this device only. Server records stay unchanged; you’ll enter your details next time.
                        </div>
                      </div>
                    </div>
                  )}
                </div>
          
                {/* 3) Close */}
                <div className="flex justify-end">
                  <button
                    type="button"
                    className={btnSecondary}
                    onClick={() => setOpenSettings(false)}
                  >
                    Done
                  </button>
                </div>
              </div>
            </Section>
          )}

          {tab==="log" && (
            <>
              <Section title="Prospect">
                <LabeledInput label="Prospect Name *">
                  <TextInput value={form.prospectName} onChange={v=>setForm(f=>({...f,prospectName:v}))} placeholder="e.g., Juan Dela Cruz"/>
                </LabeledInput>
                <div className="grid grid-cols-2 gap-3">
                  <LabeledInput label="Date"><TextInput type="date" value={form.date} onChange={v=>setForm(f=>({...f,date:v}))}/></LabeledInput>
                  <LabeledInput label="Time"><TextInput type="time" value={form.time} onChange={v=>setForm(f=>({...f,time:v}))}/></LabeledInput>
                </div>
              </Section>

              <Section title="Meeting Details" right={<span className="text-xs text-slate-500">{dayName(form.date)}</span>}>
                <LabeledInput label="Meeting Place">
                  <ChoiceGrid options={MEETING_PLACES} value={form.meetingPlace} onChange={(v)=>setForm(f=>({...f,meetingPlace:v}))}/>
                </LabeledInput>
                <div className="grid grid-cols-2 gap-3">
                  <LabeledInput label="# of Meetings (so far)"><NumberInput value={form.meetingCount} onChange={v=>setForm(f=>({...f,meetingCount:v}))} min={1}/></LabeledInput>
                  <LabeledInput label="Referrals Given (count)"><NumberInput value={form.referralsGiven} onChange={v=>setForm(f=>({...f,referralsGiven:v}))} min={0}/></LabeledInput>
                </div>
              </Section>

              <Section title="What happened? (tap to toggle)">
                <YesNoGrid items={yesNoItems} form={form} setForm={setForm}/>
              </Section>

              <Section title="Amounts & Product (optional)">
                <div className="grid grid-cols-2 gap-3">
                  <LabeledInput label="FYP (₱)">
                    <MoneyInput
                      value={form.fyp}
                      onChange={(v) => setForm(f => ({ ...f, fyp: v }))}
                      placeholder="e.g., 12,000"
                      disabled={!canEditAmounts}
                    />
                  </LabeledInput>
              
                  <LabeledInput label="FYC (₱)">
                    <MoneyInput
                      value={form.fyc}
                      onChange={(v) => setForm(f => ({ ...f, fyc: v }))}
                      placeholder="e.g., 2,400"
                      disabled={!canEditAmounts}
                    />
                  </LabeledInput>
                </div>
              
                <LabeledInput label="Product">
                  <Select
                    value={form.product}
                    onChange={(v) => setForm(f => ({ ...f, product: v }))}
                    options={PRODUCT_OPTIONS}
                    placeholder="-- Select Product --"
                    disabled={!canEditAmounts}
                  />
                </LabeledInput>
              </Section>

              <div className="mb-36 flex gap-3">
                {editingId && (
                  <button onClick={cancelEdit}
                    className={btnSecondary}>
                    Cancel
                  </button>
                )}
              
                <button onClick={resetForm}
                  className={btnSecondary}>
                  Clear
                </button>
              
                <button onClick={handleSubmit} disabled={isSending}
                  className={cls(
                    "flex-1 h-12 rounded-2xl px-4 text-base font-semibold text-white active:scale-[0.99]",
                    isSending ? "bg-slate-400 cursor-not-allowed" : "bg-slate-900"
                  )}>
                  {isSending ? "Sending…" : (editingId ? "Update" : "Submit")}
                </button>
              </div>

            </>
          )}

          {tab==="history" && (
            <Section title="Local History">
              <div className="space-y-3">
                {history.length===0 && <div className="text-sm text-slate-500">No entries yet.</div>}
                {history.map(r=>{
                  const hasBadges = r.factFinding==="Yes"||r.appSubmitted==="Yes"||r.casePaid==="Yes"||r.caseApproved==="Yes";
                  const hasMoney = !!r.fyp || !!r.fyc;
                  const hasProduct = !!r.product;
                  const hasStats = hasMoney || hasProduct;
                  return (
                    <div key={r.id} className="rounded-2xl border border-slate-200 bg-white p-3 shadow-sm">
                      <div className="flex items-start justify-between gap-3">
                        <div className="flex-1 min-w-0 font-semibold text-lg leading-tight break-words">{r.prospect}</div>
                        <div className="shrink-0 flex items-center gap-2">
                          <div className="whitespace-nowrap text-xs text-slate-500">{r.date} {r.appointmentTime}</div>
                        </div>
                      </div>

                      <div className="mt-1 text-xs text-slate-600 flex items-center gap-1">
                        <span>{r.meetingPlace||"—"}</span><span>•</span>
                        <span className={r.firstMeeting==="Yes"?"text-emerald-600":""}>
                          {r.firstMeeting==="Yes" ? "First meeting" : (Number(r.noOfMeetings)>0 ? `Mtgs: ${r.noOfMeetings}` : "—")}
                        </span>
                      </div>
                      {Number(r.referralsGiven)>0 && <div className="mt-1 text-xs text-slate-600">Referrals: {Number(r.referralsGiven)}</div>}

                      {!hasBadges && !hasStats ? (
                        <div className="my-3 h-px bg-slate-200"></div>
                      ) : (
                        <>
                          <div className="my-3 h-px bg-slate-200"></div>
                          {hasBadges && (
                            <div className="flex flex-wrap gap-2 text-[11px] sm:text-xs">
                              {r.factFinding==="Yes" && <Badge>KYC Done</Badge>}
                              {r.appSubmitted==="Yes" && <Badge>Submitted</Badge>}
                              {r.casePaid==="Yes" && <Badge>Paid</Badge>}
                              {r.caseApproved==="Yes" && <Badge>Approved</Badge>}
                            </div>
                          )}
                          {hasBadges && hasStats && <div className="my-3 h-px bg-slate-200"></div>}

                          <div className="mt-3 flex items-center justify-between">
                            <div>
                              {hasMoney && (
                                <div className="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-slate-600">
                                  {r.fyp && <span>FYP ₱{Number(r.fyp).toLocaleString()}</span>}
                                  {r.fyc && <span>• FYC ₱{Number(r.fyc).toLocaleString()}</span>}
                                </div>
                              )}
                              {hasProduct && <div className="mt-1 text-xs text-slate-600">{r.product}</div>}
                            </div>
                          
                            <button
                              className={btnSecondary}
                              onClick={() => startEdit(r)}
                            >
                              Edit
                            </button>
                          </div>

                        </>
                      )}

                    </div>
                  );
                })}
              </div>
            </Section>
          )}

          {tab==="prospecting" && (
            <Section title="Prospecting">
              <div className="grid gap-3">
                <LabeledInput label="Date">
                  <TextInput
                    type="date"
                    value={prospecting.date}
                    onChange={v => setProspecting(p => ({ ...p, date: v }))}
                  />
                </LabeledInput>
          
                <div className="text-xs text-slate-500 -mt-2 mb-1">
                  Week ending (Sunday): <span className="font-semibold">{weekEnding}</span>
                </div>
          
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <CounterCard
                    label="Approaches"
                    value={prospecting.approaches}
                    onPlus={() => inc('approaches')}
                    onMinus={() => dec('approaches')}
                  />
                  <CounterCard
                    label="Set Appointments"
                    value={prospecting.setApps}
                    onPlus={() => inc('setApps')}
                    onMinus={() => dec('setApps')}
                  />
                </div>
          
                <div className="mt-2 flex gap-3">
                  <button
                    onClick={() => setProspecting(p => ({ ...p, approaches: 0, setApps: 0 }))}
                    className={btnSecondary}
                  >
                    Clear
                  </button>
                  <button
                    onClick={submitProspecting}
                    className="flex-1 h-12 rounded-2xl bg-slate-900 px-4 text-base font-semibold text-white active:scale-[0.99] hover:opacity-95"
                  >
                    Submit
                  </button>
                </div>
              </div>
            </Section>
          )}

          <FloatingTabBar tab={tab} setTab={goToTab} />
          
          {toast && <Toast text={toast.t} quote={toast.quote} type={toast.type||"ok"} onClose={()=>setToast(null)}/>}
        </Page>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
